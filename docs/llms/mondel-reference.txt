MONDEL LLM REFERENCE
====================

Purpose
-------
Mondel is a lightweight TypeScript ORM for MongoDB with:
- schema definition via functions (`defineSchema`, `s`)
- type-safe collection access via `createClient`
- runtime validation powered by generated Zod schemas
- CLI for schema pull/push workflows (`npx mondel`)

Installation
------------
npm install mondel mongodb zod

Core API
--------
1) define schema

import { defineSchema, s } from "mondel";

const userSchema = defineSchema("users", {
  collection: "users",
  timestamps: true,
  fields: {
    email: s.string().required().unique(),
    name: s.string(),
    role: s.enum(["ADMIN", "USER"]).default("USER"),
  },
  indexes: [
    { fields: { role: 1, createdAt: -1 }, options: { name: "idx_role_created" } },
  ],
});

2) create client (serverless)

import { createClient } from "mondel";

const connect = createClient({
  serverless: true,
  schemas: [userSchema] as const,
  validation: "strict",
});

const db = await connect(process.env.MONGODB_URI!);

3) create client (node)

const db = await createClient({
  uri: process.env.MONGODB_URI!,
  schemas: [userSchema] as const,
  validation: "strict",
});

4) collection methods
- findOne(where?, options?)
- findMany(where?, options?)
- findById(id, options?)
- create(data, options?)
- createMany(data[], options?)
- updateOne(where, data, options?)
- updateMany(where, data, options?)
- updateById(id, data, options?)
- deleteOne(where, options?)
- deleteMany(where, options?)
- deleteById(id, options?)
- count(where?, options?)
- exists(where, options?)
- aggregate(pipeline, options?)
- getCollection()

5) validation
- Validation mode: "strict" | "loose" | "off"
- Utilities:
  - zodSchema(schema)
  - zodCreateSchema(schema)
  - zodUpdateSchema(schema)
  - validate(schema, data)

6) syncIndexes status
- `syncIndexes` in createClient is deprecated.
- Preferred flow: use CLI `npx mondel push` outside app startup.

CLI Overview
------------
Entry command: npx mondel

Commands:
- npx mondel pull
- npx mondel push

Common options:
- --config <file>   // .ts/.js/.mjs/.cjs/.json
- --uri <mongodb-uri>

Database selection is implicit in URI (no separate database config property).

Pull Command
------------
Purpose:
- introspect remote DB collections
- infer fields from sample docs
- capture indexes
- generate TS schema files or JSON manifest

Options:
- --format ts|json
- --out <file>
- --out-dir <dir>
- --per-collection

Examples:
- npx mondel pull --uri mongodb://localhost:27017/app --out ./src/db/schemas.ts
- npx mondel pull --uri mongodb://localhost:27017/app --out-dir ./src/db/schemas --per-collection
- npx mondel pull --uri mongodb://localhost:27017/app --format json --out ./schema-manifest.json

Pull output behavior:
- single file mode (`--out`): generates one TS file exporting all schemas
- per collection mode (`--out-dir --per-collection`): generates
  - one <collection>.schema.ts per collection
  - one index.ts exporting `schemas`
- generated schema variable names are singular camelCase
  - example: users_log -> userLog

Push Command
------------
Purpose:
- create/update indexes on remote DB
- optional validator apply
- optional unmanaged index cleanup

Options:
- --schema <file>       // built JS module with exported schemas
- --manifest <file>     // manifest JSON from pull --format json
- --export <name>       // export name in schema module, default: schemas
- --apply-validators
- --drop-indexes
- --dry-run

Examples:
- npx mondel push --uri mongodb://localhost:27017/app --schema ./dist/schemas.js --apply-validators
- npx mondel push --uri mongodb://localhost:27017/app --manifest ./schema-manifest.json --drop-indexes
- npx mondel push --uri mongodb://localhost:27017/app --schema ./dist/schemas.js --dry-run

CLI Config File
---------------
Type exported by Mondel:
- MondelCliConfig

Config shape:
- uri?: string
- pull?: {
    uri?: string
    format?: "ts" | "json"
    outFile?: string
    outDir?: string
    perCollectionFiles?: boolean
  }
- push?: {
    uri?: string
    schemaFile?: string
    manifestFile?: string
    schemaExport?: string
    applyValidators?: boolean
    dropIndexes?: boolean
    dryRun?: boolean
  }

TypeScript config example (with dotenv):

import "dotenv/config";
import type { MondelCliConfig } from "mondel";

export default {
  uri: process.env.MONGODB_URI,
  pull: {
    format: "ts",
    outDir: "./src/db/schemas",
    perCollectionFiles: true,
  },
  push: {
    schemaFile: "./dist/schemas.js",
    schemaExport: "schemas",
    applyValidators: true,
    dropIndexes: false,
  },
} satisfies MondelCliConfig;

Execution with config:
- npx mondel pull --config ./mondel.config.ts
- npx mondel push --config ./mondel.config.ts

CLI flags override config values when both are provided.

Best Practices
--------------
- Keep runtime app startup free of schema sync work.
- Run `npx mondel push` in CI/deploy scripts.
- Use `pull` to bootstrap schema from existing DBs.
- Use `--dry-run` before destructive operations like `--drop-indexes`.
- Keep schema modules compiled before `push --schema`.
